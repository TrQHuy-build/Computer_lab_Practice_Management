@model SapXepLichViewModel
@{
    ViewData["Title"] = "Sắp xếp lịch thực hành";
    var choPhep = Model?.ChoPhepXepLich ?? false;
    var tongHP = Model?.TongHocPhan ?? 0;
    var daXep = Model?.DaXepLich ?? 0;
    var chuaXep = Model?.ChuaXepLich ?? 0;
    var tiLe = tongHP > 0 ? (daXep * 100.0 / tongHP) : 0;
}

<style>
    /* ===== DASHBOARD THỐNG KÊ ===== */
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
        transition: transform 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .stat-card.success { border-left-color: #28a745; }
    .stat-card.warning { border-left-color: #ffc107; }
    .stat-card.danger { border-left-color: #dc3545; }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .stat-title {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .stat-icon.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .stat-icon.success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; }
    .stat-icon.warning { background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white; }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 5px;
    }

    .stat-progress {
        margin-top: 10px;
    }

    .stat-progress .progress {
        height: 8px;
        border-radius: 10px;
        background: #e9ecef;
    }

    .stat-progress .progress-bar {
        border-radius: 10px;
        transition: width 0.6s ease;
    }

    /* ===== ACTIONS BAR ===== */
    .actions-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 25px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .actions-bar .btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        font-weight: 500;
    }

    /* ===== MAIN CONTAINER ===== */
    .sapxep-container {
        display: flex;
        gap: 20px;
        min-height: 600px;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
        width: 320px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .sidebar-tabs {
        display: flex;
        border-bottom: 2px solid #e9ecef;
    }

    .sidebar-tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        background: white;
        border: none;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.3s;
        position: relative;
    }

    .sidebar-tab.active {
        color: #667eea;
    }

    .sidebar-tab.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: #667eea;
    }

    .sidebar-tab:hover {
        background: #f8f9fa;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .sidebar-content .tab-pane {
        display: none;
    }

    .sidebar-content .tab-pane.active {
        display: block;
    }

    /* ===== PHÒNG LIST ===== */
    .phong-search {
        position: relative;
        margin-bottom: 15px;
    }

    .phong-search .bi-search {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }

    .phong-search input {
        padding-left: 38px;
        border-radius: 8px;
    }

    .phong-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
    }

    .phong-actions .btn {
        flex: 1;
        font-size: 0.85rem;
        padding: 8px;
    }

    .phong-item {
        display: flex;
        align-items: center;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        background: #f8f9fa;
    }

    .phong-item:hover {
        background: white;
        border-color: #667eea;
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
    }

    .phong-item.selected {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border-color: #667eea;
    }

    .phong-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        cursor: pointer;
    }

    .phong-info {
        flex: 1;
    }

    .phong-name {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 4px;
    }

    .phong-capacity {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .phong-count {
        margin-top: 10px;
        padding: 10px;
        background: #e7f3ff;
        border-radius: 6px;
        text-align: center;
        font-size: 0.9rem;
        color: #0056b3;
        font-weight: 500;
    }

    /* ===== HỌC PHẦN CHƯA XẾP ===== */
    .hocphan-item {
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        background: white;
        transition: all 0.2s;
    }

    .hocphan-item:hover {
        border-color: #667eea;
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
    }

    .hocphan-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 10px;
    }

    .hocphan-code {
        font-weight: 700;
        color: #dc3545;
        font-size: 0.95rem;
    }

    .hocphan-name {
        font-size: 0.9rem;
        color: #2d3748;
        margin-bottom: 8px;
    }

    .hocphan-meta {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 5px;
    }

    .hocphan-meta i {
        width: 16px;
        margin-right: 4px;
    }

    .hocphan-actions {
        margin-top: 10px;
    }

    /* ===== CALENDAR CONTAINER ===== */
    .calendar-container {
        flex: 1;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .calendar-header {
        padding: 20px;
        border-bottom: 2px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .calendar-title {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .calendar-title h5 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
        color: #2d3748;
    }

    .view-toggle {
        display: flex;
        gap: 5px;
        background: #f1f3f5;
        padding: 4px;
        border-radius: 8px;
    }

    .view-toggle button {
        padding: 8px 16px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.2s;
    }

    .view-toggle button.active {
        background: white;
        color: #667eea;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .month-nav {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .month-nav button {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .month-nav button:hover {
        border-color: #667eea;
        background: #f8f9fa;
    }

    .current-month {
        font-weight: 600;
        color: #2d3748;
        min-width: 150px;
        text-align: center;
    }

    .calendar-filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* ===== CALENDAR GRID ===== */
    .calendar-wrapper {
        flex: 1;
        overflow: auto;
        padding: 20px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        min-width: 900px;
    }

    .calendar-day-header {
        text-align: center;
        padding: 12px;
        font-weight: 600;
        color: #495057;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .calendar-day {
        min-height: 120px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 8px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
        display: flex;
        flex-direction: column;
    }

    .calendar-day:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
    }

    .calendar-day.other-month {
        background: #f8f9fa;
        opacity: 0.5;
    }

    .calendar-day.today {
        border-color: #667eea;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    }

    .calendar-day.has-schedule {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
    }

    .day-number {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 8px;
        color: #2d3748;
    }

    .day-schedules {
        flex: 1;
        overflow-y: auto;
        font-size: 0.75rem;
    }

    .schedule-chip {
        padding: 4px 8px;
        margin-bottom: 4px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .schedule-chip.ca1 { background: #e3f2fd; color: #1976d2; border-left: 3px solid #1976d2; }
    .schedule-chip.ca2 { background: #f3e5f5; color: #7b1fa2; border-left: 3px solid #7b1fa2; }
    .schedule-chip.ca3 { background: #fff3e0; color: #f57c00; border-left: 3px solid #f57c00; }
    .schedule-chip.ca4 { background: #e8f5e9; color: #388e3c; border-left: 3px solid #388e3c; }

    .schedule-chip.pending { opacity: 0.7; }
    .schedule-chip.approved { border-left-width: 4px; }

    .schedule-more {
        text-align: center;
        padding: 4px;
        color: #667eea;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
    }

    .schedule-more:hover {
        text-decoration: underline;
    }

    /* ===== LIST VIEW ===== */
    .list-view {
        display: none;
        padding: 20px;
    }

    .list-view.active {
        display: block;
    }

    .list-view table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
    }

    .list-view th {
        background: #f8f9fa;
        padding: 12px;
        font-weight: 600;
        color: #495057;
        border: none;
    }

    .list-view td {
        padding: 12px;
        background: white;
        border: 1px solid #e9ecef;
    }

    .list-view tr {
        transition: all 0.2s;
    }

    .list-view tbody tr:hover {
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* ===== LEGEND ===== */
    .legend {
        padding: 15px 20px;
        border-top: 2px solid #e9ecef;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        background: #f8f9fa;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .legend-box {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 2px solid;
    }

    .legend-box.ca1 { background: #e3f2fd; border-color: #1976d2; }
    .legend-box.ca2 { background: #f3e5f5; border-color: #7b1fa2; }
    .legend-box.ca3 { background: #fff3e0; border-color: #f57c00; }
    .legend-box.ca4 { background: #e8f5e9; border-color: #388e3c; }

    /* ===== RESPONSIVE ===== */
    @@media (max-width: 1200px) {
        .sapxep-container {
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
            max-height: 500px;
        }

        .calendar-grid {
            min-width: 100%;
        }
    }

    @@media (max-width: 768px) {
        .dashboard-stats {
            grid-template-columns: 1fr;
        }

        .actions-bar {
            flex-direction: column;
        }

        .actions-bar .btn {
            width: 100%;
        }
    }

    /* ===== SCROLLBAR ===== */
    .sidebar-content::-webkit-scrollbar,
    .calendar-wrapper::-webkit-scrollbar,
    .day-schedules::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .sidebar-content::-webkit-scrollbar-thumb,
    .calendar-wrapper::-webkit-scrollbar-thumb,
    .day-schedules::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 3px;
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover,
    .calendar-wrapper::-webkit-scrollbar-thumb:hover,
    .day-schedules::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
</style>

<!-- ===== CẢNH BÁO THỜI GIAN ===== -->
@if (!choPhep)
{
    <div class="alert alert-warning alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Lưu ý:</strong> Hiện không phải giai đoạn sắp xếp lịch (Tuần 3 tiền học kỳ). Bạn chỉ có thể xem lịch.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- ===== DASHBOARD THỐNG KÊ ===== -->
<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-title">Tổng học phần</div>
                <div class="stat-value">@tongHP</div>
                <small class="text-muted">HP cần xếp lịch</small>
            </div>
            <div class="stat-icon primary">
                <i class="bi bi-book"></i>
            </div>
        </div>
    </div>

    <div class="stat-card success">
        <div class="stat-header">
            <div>
                <div class="stat-title">Đã xếp lịch</div>
                <div class="stat-value text-success">@daXep</div>
                <small class="text-muted">HP đã hoàn thành</small>
            </div>
            <div class="stat-icon success">
                <i class="bi bi-check-circle"></i>
            </div>
        </div>
    </div>

    <div class="stat-card warning">
        <div class="stat-header">
            <div>
                <div class="stat-title">Chưa xếp lịch</div>
                <div class="stat-value text-warning">@chuaXep</div>
                <small class="text-muted">HP cần xử lý</small>
            </div>
            <div class="stat-icon warning">
                <i class="bi bi-hourglass-split"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div style="width: 100%;">
                <div class="stat-title">Tiến độ hoàn thành</div>
                <div class="stat-value">@tiLe.ToString("F1")%</div>
                <div class="stat-progress">
                    <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" style="width: @tiLe%"></div>
                    </div>
                    <small class="text-muted mt-1 d-block">@daXep/@tongHP học phần</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== ACTIONS BAR ===== -->
@if (choPhep)
{
    <div class="actions-bar">
        <button type="button" class="btn btn-success" onclick="showAutoScheduleForm()">
            <i class="bi bi-robot"></i>
            <span>Sắp xếp tự động</span>
        </button>
        <button type="button" class="btn btn-primary" id="btnGuiDuyet">
            <i class="bi bi-send"></i>
            <span>Gửi duyệt (@daXep lịch)</span>
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="refreshCalendar()">
            <i class="bi bi-arrow-clockwise"></i>
            <span>Làm mới</span>
        </button>
        <button type="button" class="btn btn-outline-info" onclick="exportExcel()">
            <i class="bi bi-file-earmark-excel"></i>
            <span>Xuất Excel</span>
        </button>
    </div>
}

<!-- ===== MAIN CONTAINER ===== -->
<div class="sapxep-container">
    <!-- ===== SIDEBAR ===== -->
    <div class="sidebar">
        <!-- Tabs -->
        <div class="sidebar-tabs">
            <button class="sidebar-tab active" data-tab="phong">
                <i class="bi bi-building me-1"></i> Phòng (@(Model?.DanhSachPhong?.Count ?? 0))
            </button>
            <button class="sidebar-tab" data-tab="hocphan">
                <i class="bi bi-list-task me-1"></i> Chưa xếp (@chuaXep)
            </button>
        </div>

        <!-- Tab Content -->
        <div class="sidebar-content">
            <!-- Tab Phòng -->
            <div class="tab-pane active" id="tab-phong">
                <!-- Search -->
                <div class="phong-search">
                    <i class="bi bi-search"></i>
                    <input type="text" id="searchPhong" class="form-control" placeholder="Tìm kiếm phòng...">
                </div>

                <!-- Actions -->
                <div class="phong-actions">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllPhong()">
                        <i class="bi bi-check-all"></i> Chọn tất cả
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllPhong()">
                        <i class="bi bi-x"></i> Bỏ chọn
                    </button>
                </div>

                <!-- List -->
                <div id="danhSachPhong">
                    @if (Model?.DanhSachPhong != null && Model.DanhSachPhong.Any())
                    {
                        @foreach (var phong in Model.DanhSachPhong)
                        {
                            <div class="phong-item" data-phong-id="@phong.Id" data-phong-name="@phong.TenPhong @phong.MaPhong">
                                <input type="checkbox" class="phong-checkbox" value="@phong.Id" id="phong_@phong.Id">
                                <label class="phong-info" for="phong_@phong.Id">
                                    <div class="phong-name">@phong.MaPhong - @phong.TenPhong</div>
                                    <div class="phong-capacity">
                                        <i class="bi bi-pc-display"></i> @phong.SoMayHoatDong/@phong.SucChua máy
                                    </div>
                                </label>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-2">Không có phòng nào</p>
                        </div>
                    }
                </div>

                <!-- Count -->
                <div class="phong-count" id="phongCount">
                    Đã chọn: <strong>0</strong>/@(Model?.DanhSachPhong?.Count ?? 0) phòng
                </div>
            </div>

            <!-- Tab Học phần chưa xếp -->
            <div class="tab-pane" id="tab-hocphan">
                <div id="danhSachHocPhanChuaXep">
                    @if (Model?.DanhSachHocPhan != null && Model.DanhSachHocPhan.Any())
                    {
                        var chuaXepList = Model.DanhSachHocPhan
                            .Where(hp => !Model.KetQuaXepLich.Any(l => l.HocPhanId == hp.HocPhanId))
                            .ToList();

                        @if (chuaXepList.Any())
                        {
                            @foreach (var hp in chuaXepList)
                            {
                                <div class="hocphan-item">
                                    <div class="hocphan-header">
                                        <div class="hocphan-code">@hp.MaHocPhan</div>
                                    </div>
                                    <div class="hocphan-name">@hp.TenHocPhan</div>
                                    <div class="hocphan-meta">
                                        <i class="bi bi-person"></i> GV: @(hp.TenGiangVien ?? "Chưa phân công")
                                    </div>
                                    <div class="hocphan-meta">
                                        <i class="bi bi-calendar3"></i> Cần: @hp.SoBuoiThucHanh buổi
                                    </div>
                                    <div class="hocphan-actions">
                                        <button type="button" class="btn btn-sm btn-primary w-100" 
                                                onclick="xepLichThuCong(@hp.HocPhanId, '@hp.MaHocPhan', '@hp.TenHocPhan')">
                                            <i class="bi bi-plus-circle me-1"></i> Xếp thủ công
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-check-circle" style="font-size: 3rem; color: #28a745;"></i>
                                <p class="mt-2">Đã xếp lịch tất cả học phần!</p>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-2">Không có học phần nào</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CALENDAR CONTAINER ===== -->
    <div class="calendar-container">
        <!-- Header -->
        <div class="calendar-header">
            <div class="calendar-title">
                <h5><i class="bi bi-calendar3 me-2"></i>Lịch thực hành</h5>
                <div class="view-toggle">
                    <button class="active" data-view="calendar" onclick="switchView('calendar')">
                        <i class="bi bi-calendar3"></i> Lịch
                    </button>
                    <button data-view="list" onclick="switchView('list')">
                        <i class="bi bi-list-ul"></i> Danh sách
                    </button>
                </div>
            </div>

            <div class="month-nav">
                <button type="button" id="prevMonth">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="current-month" id="currentMonth">Tháng 2, 2026</span>
                <button type="button" id="nextMonth">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>

            <div class="calendar-filters">
                <select class="form-select form-select-sm" id="filterStatus" onchange="filterSchedules()">
                    <option value="all">Tất cả trạng thái</option>
                    <option value="0">Chưa duyệt</option>
                    <option value="1">Chờ TTDT duyệt</option>
                    <option value="2">Đã duyệt</option>
                </select>
            </div>
        </div>

        <!-- Calendar View -->
        <div class="calendar-wrapper" id="calendarView">
            <div class="calendar-grid" id="calendarGrid">
                <!-- Headers -->
                <div class="calendar-day-header">Thứ Hai</div>
                <div class="calendar-day-header">Thứ Ba</div>
                <div class="calendar-day-header">Thứ Tư</div>
                <div class="calendar-day-header">Thứ Năm</div>
                <div class="calendar-day-header">Thứ Sáu</div>
                <div class="calendar-day-header">Thứ Bảy</div>
                <div class="calendar-day-header">Chủ Nhật</div>
                <!-- Days will be generated by JavaScript -->
            </div>
        </div>

        <!-- List View -->
        <div class="list-view" id="listView">
            <table class="table">
                <thead>
                    <tr>
                        <th>Ngày</th>
                        <th>Ca</th>
                        <th>Học phần</th>
                        <th>Giảng viên</th>
                        <th>Phòng</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="listViewBody">
                    <!-- Will be generated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box ca1"></div>
                <span>Ca 1 (7:00-9:00)</span>
            </div>
            <div class="legend-item">
                <div class="legend-box ca2"></div>
                <span>Ca 2 (9:15-11:15)</span>
            </div>
            <div class="legend-item">
                <div class="legend-box ca3"></div>
                <span>Ca 3 (13:00-15:00)</span>
            </div>
            <div class="legend-item">
                <div class="legend-box ca4"></div>
                <span>Ca 4 (15:15-17:15)</span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // ===== DATA =====
    const lichData = @Html.Raw(Json.Serialize(Model?.KetQuaXepLich ?? new List<QL_TH_MT.ViewModels.LichThucHanhDto>()));
    const hocPhanData = @Html.Raw(Json.Serialize(Model?.DanhSachHocPhan ?? new List<QL_TH_MT.ViewModels.HocPhanCanXepLichViewModel>()));
    const phongData = @Html.Raw(Json.Serialize(Model?.DanhSachPhong ?? new List<QL_TH_MT.Models.PhongThucHanhNew>()));
    const choPhep = @Json.Serialize(choPhep);
    
    // ===== STATE =====
    let currentDate = new Date();
    let selectedPhongs = [];
    let currentView = 'calendar';
    let filterStatus = 'all';
    
    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', function() {
        initSidebar();
        initPhongSelector();
        renderCalendar();
        setupEventListeners();
    });
    
    // ===== SIDEBAR TABS =====
    function initSidebar() {
        const tabs = document.querySelectorAll('.sidebar-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                // Remove active class
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                
                // Add active class
                this.classList.add('active');
                document.getElementById('tab-' + tabName).classList.add('active');
            });
        });
    }
    
    // ===== PHÒNG SELECTOR =====
    function initPhongSelector() {
        const searchInput = document.getElementById('searchPhong');
        const checkboxes = document.querySelectorAll('.phong-checkbox');
        const phongItems = document.querySelectorAll('.phong-item');
        
        // Search
        searchInput?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            phongItems.forEach(item => {
                const name = item.dataset.phongName.toLowerCase();
                item.style.display = name.includes(searchTerm) ? 'flex' : 'none';
            });
        });
        
        // Checkbox change
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const phongId = this.value;
                const phongItem = this.closest('.phong-item');
                
                if (this.checked) {
                    selectedPhongs.push(phongId);
                    phongItem.classList.add('selected');
                } else {
                    selectedPhongs = selectedPhongs.filter(id => id !== phongId);
                    phongItem.classList.remove('selected');
                }
                
                updatePhongCount();
                renderCalendar();
            });
        });
        
        // Click on item
        phongItems.forEach(item => {
            item.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                    const checkbox = this.querySelector('.phong-checkbox');
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        });
    }
    
    function selectAllPhong() {
        document.querySelectorAll('.phong-checkbox').forEach(cb => {
            if (!cb.checked) {
                cb.checked = true;
                cb.dispatchEvent(new Event('change'));
            }
        });
    }
    
    function clearAllPhong() {
        document.querySelectorAll('.phong-checkbox').forEach(cb => {
            if (cb.checked) {
                cb.checked = false;
                cb.dispatchEvent(new Event('change'));
            }
        });
    }
    
    function updatePhongCount() {
        const countEl = document.getElementById('phongCount');
        const total = document.querySelectorAll('.phong-checkbox').length;
        const selected = selectedPhongs.length;
        countEl.innerHTML = `Đã chọn: <strong>${selected}</strong>/${total} phòng`;
    }
    
    // ===== CALENDAR RENDERING =====
    function renderCalendar() {
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthSpan = document.getElementById('currentMonth');
        
        // Update month display
        const monthNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                           'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
        currentMonthSpan.textContent = `${monthNames[currentDate.getMonth()]}, ${currentDate.getFullYear()}`;
        
        // Clear existing days (keep headers)
        const headers = calendarGrid.querySelectorAll('.calendar-day-header');
        calendarGrid.innerHTML = '';
        headers.forEach(header => calendarGrid.appendChild(header));
        
        // Calculate calendar data
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        // Convert to Monday-based (0=Monday, 6=Sunday)
        let startingDayOfWeek = firstDay.getDay() - 1;
        if (startingDayOfWeek === -1) startingDayOfWeek = 6;
        
        const daysInMonth = lastDay.getDate();
        
        // Add empty cells
        for (let i = 0; i < startingDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day other-month';
            calendarGrid.appendChild(emptyDay);
        }
        
        // Add days
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            const currentDayDate = new Date(year, month, day);
            const isToday = currentDayDate.toDateString() === today.toDateString();
            
            if (isToday) {
                dayElement.classList.add('today');
            }
            
            // Day number
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            dayElement.appendChild(dayNumber);
            
            // Schedules
            const schedulesDiv = document.createElement('div');
            schedulesDiv.className = 'day-schedules';
            
            const daySchedules = getSchedulesForDay(year, month, day);
            
            if (daySchedules.length > 0) {
                dayElement.classList.add('has-schedule');
                
                // Show max 3 schedules
                const maxShow = 3;
                daySchedules.slice(0, maxShow).forEach(schedule => {
                    const chip = createScheduleChip(schedule);
                    schedulesDiv.appendChild(chip);
                });
                
                // Show more link
                if (daySchedules.length > maxShow) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'schedule-more';
                    moreDiv.textContent = `+${daySchedules.length - maxShow} ca nữa...`;
                    moreDiv.onclick = (e) => {
                        e.stopPropagation();
                        showDayDetails(year, month, day);
                    };
                    schedulesDiv.appendChild(moreDiv);
                }
            }
            
            dayElement.appendChild(schedulesDiv);
            
            // Click handler
            dayElement.addEventListener('click', () => showDayDetails(year, month, day));
            
            calendarGrid.appendChild(dayElement);
        }
        
        // Update list view
        renderListView();
    }
    
    function getSchedulesForDay(year, month, day) {
        return lichData.filter(lich => {
            const lichDate = new Date(lich.ngayThucHanh);
            const matchDate = lichDate.getDate() === day && 
                             lichDate.getMonth() === month && 
                             lichDate.getFullYear() === year;
            
            const matchPhong = selectedPhongs.length === 0 || 
                              selectedPhongs.includes(lich.phongThucHanhId.toString());
            
            const matchStatus = filterStatus === 'all' || 
                               lich.trangThai.toString() === filterStatus;
            
            return matchDate && matchPhong && matchStatus;
        }).sort((a, b) => a.caHoc - b.caHoc);
    }
    
    function createScheduleChip(schedule) {
        const chip = document.createElement('div');
        chip.className = `schedule-chip ca${schedule.caHoc}`;
        
        if (schedule.trangThai === 0) chip.classList.add('pending');
        if (schedule.trangThai === 2) chip.classList.add('approved');
        
        // Find HP info
        const hp = hocPhanData.find(h => h.id === schedule.hocPhanId);
        const tenMon = hp?.maHocPhan || 'N/A';
        
        chip.innerHTML = `<span>Ca ${schedule.caHoc}:</span> ${tenMon}`;
        chip.title = `${hp?.tenHocPhan || ''} - ${hp?.giangVien?.hoTen || ''}`;
        
        return chip;
    }
    
    // ===== LIST VIEW =====
    function renderListView() {
        const tbody = document.getElementById('listViewBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        const filteredLich = lichData
            .filter(l => {
                const matchPhong = selectedPhongs.length === 0 || 
                                  selectedPhongs.includes(l.phongThucHanhId.toString());
                const matchStatus = filterStatus === 'all' || 
                                   l.trangThai.toString() === filterStatus;
                return matchPhong && matchStatus;
            })
            .sort((a, b) => new Date(a.ngayThucHanh) - new Date(b.ngayThucHanh) || a.caHoc - b.caHoc);
        
        filteredLich.forEach(lich => {
            const hp = hocPhanData.find(h => h.id === lich.hocPhanId);
            const phong = phongData.find(p => p.id === lich.phongThucHanhId);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${new Date(lich.ngayThucHanh).toLocaleDateString('vi-VN')}</td>
                <td><span class="badge bg-primary">Ca ${lich.caHoc}</span></td>
                <td><strong>${hp?.maHocPhan || 'N/A'}</strong><br><small>${hp?.tenHocPhan || ''}</small></td>
                <td>${hp?.giangVien?.hoTen || 'N/A'}</td>
                <td>${phong?.tenPhong || 'N/A'}</td>
                <td>${getStatusBadge(lich.trangThai)}</td>
                <td>
                    ${choPhep ? `
                    <button class="btn btn-sm btn-outline-primary" onclick="editSchedule(${lich.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSchedule(${lich.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                    ` : `
                    <button class="btn btn-sm btn-outline-info" onclick="viewScheduleDetail(${lich.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                    `}
                </td>
            `;
            tbody.appendChild(row);
        });
        
        if (filteredLich.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Không có lịch nào</td></tr>';
        }
    }
    
    function getStatusBadge(status) {
        switch(status) {
            case 0: return '<span class="badge bg-secondary">Chưa duyệt</span>';
            case 1: return '<span class="badge bg-warning">Chờ TTDT</span>';
            case 2: return '<span class="badge bg-success">Đã duyệt</span>';
            case 3: return '<span class="badge bg-danger">Bị từ chối</span>';
            default: return '<span class="badge bg-secondary">N/A</span>';
        }
    }
    
    // ===== VIEW SWITCHING =====
    function switchView(view) {
        currentView = view;
        
        document.querySelectorAll('.view-toggle button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.view-toggle button[data-view="${view}"]`).classList.add('active');
        
        if (view === 'calendar') {
            document.getElementById('calendarView').style.display = 'block';
            document.getElementById('listView').style.display = 'none';
        } else {
            document.getElementById('calendarView').style.display = 'none';
            document.getElementById('listView').style.display = 'block';
            renderListView();
        }
    }
    
    // ===== FILTERS =====
    function filterSchedules() {
        filterStatus = document.getElementById('filterStatus').value;
        renderCalendar();
    }
    
    // ===== MONTH NAVIGATION =====
    function setupEventListeners() {
        document.getElementById('prevMonth')?.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });
        
        document.getElementById('nextMonth')?.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
        
        // Gửi duyệt
        document.getElementById('btnGuiDuyet')?.addEventListener('click', guiDuyet);
    }
    
    // ===== SHOW DAY DETAILS =====
    function showDayDetails(year, month, day) {
        const dateStr = `${day}/${month+1}/${year}`;
        const daySchedules = getSchedulesForDay(year, month, day);
        
        let html = `
            <div class="text-start">
                <h6 class="mb-3 text-primary">
                    <i class="bi bi-calendar-day me-2"></i>Ngày ${dateStr}
                </h6>`;
        
        if (daySchedules.length > 0) {
            html += `<div class="list-group mb-3">`;
            
            daySchedules.forEach(schedule => {
                const hp = hocPhanData.find(h => h.id === schedule.hocPhanId);
                const phong = phongData.find(p => p.id === schedule.phongThucHanhId);
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <h6 class="mb-1">
                                <strong>Ca ${schedule.caHoc}</strong> - ${hp?.maHocPhan || 'N/A'}
                            </h6>
                            ${getStatusBadge(schedule.trangThai)}
                        </div>
                        <p class="mb-1">
                            <i class="bi bi-building me-1"></i>Phòng: <strong>${phong?.tenPhong || 'N/A'}</strong><br>
                            <i class="bi bi-person me-1"></i>GV: ${hp?.giangVien?.hoTen || 'N/A'}<br>
                            <i class="bi bi-book me-1"></i>Môn: ${hp?.tenHocPhan || 'N/A'}
                        </p>
                        ${choPhep ? `
                        <div class="btn-group btn-group-sm mt-2">
                            <button class="btn btn-outline-primary" onclick="editSchedule(${schedule.id})">
                                <i class="bi bi-pencil"></i> Sửa
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteSchedule(${schedule.id})">
                                <i class="bi bi-trash"></i> Xóa
                            </button>
                        </div>
                        ` : ''}
                    </div>`;
            });
            
            html += `</div>`;
        } else {
            html += `
                <div class="alert alert-secondary">
                    <i class="bi bi-calendar-x me-2"></i>Chưa có lịch nào trong ngày này
                </div>`;
        }
        
        html += `</div>`;
        
        Swal.fire({
            title: 'Chi tiết lịch thực hành',
            html: html,
            width: '700px',
            showCancelButton: choPhep,
            confirmButtonText: choPhep ? '<i class="bi bi-plus-circle me-2"></i>Thêm lịch' : 'Đóng',
            cancelButtonText: 'Đóng',
            confirmButtonColor: '#28a745',
            customClass: {
                popup: 'text-start'
            }
        }).then((result) => {
            if (result.isConfirmed && choPhep) {
                const dateObj = new Date(year, month, day);
                showManualScheduleForm(dateObj);
            }
        });
    }
    
    // ===== MANUAL SCHEDULE FORM =====
    function showManualScheduleForm(date) {
        const dateStr = date ? date.toISOString().split('T')[0] : '';
        
        Swal.fire({
            title: '<i class="bi bi-plus-circle me-2"></i>Xếp lịch thủ công',
            html: `
                <form id="manualScheduleForm" class="text-start">
                    <div class="mb-3">
                        <label class="form-label">Học phần <span class="text-danger">*</span></label>
                        <select class="form-select" name="HocPhanId" required>
                            <option value="">-- Chọn học phần --</option>
                            ${hocPhanData.map(hp => `<option value="${hp.id}">${hp.maHocPhan} - ${hp.tenHocPhan}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ngày thực hành <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="NgayThucHanh" value="${dateStr}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ca học <span class="text-danger">*</span></label>
                        <select class="form-select" name="CaHoc" required>
                            <option value="">-- Chọn ca --</option>
                            <option value="1">Ca 1 (7:00-9:00)</option>
                            <option value="2">Ca 2 (9:15-11:15)</option>
                            <option value="3">Ca 3 (13:00-15:00)</option>
                            <option value="4">Ca 4 (15:15-17:15)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phòng thực hành <span class="text-danger">*</span></label>
                        <select class="form-select" name="PhongThucHanhId" required>
                            <option value="">-- Chọn phòng --</option>
                            ${phongData.map(p => `<option value="${p.id}">${p.maPhong} - ${p.tenPhong} (${p.soMayHoatDong}/${p.sucChua} máy)</option>`).join('')}
                        </select>
                    </div>
                </form>
            `,
            width: '600px',
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-check-circle me-2"></i>Xếp lịch',
            cancelButtonText: '<i class="bi bi-x-circle me-2"></i>Hủy',
            confirmButtonColor: '#28a745',
            preConfirm: () => {
                const form = document.getElementById('manualScheduleForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return false;
                }
                
                const formData = new FormData(form);
                return {
                    hocPhanId: parseInt(formData.get('HocPhanId')),
                    ngayThucHanh: formData.get('NgayThucHanh'),
                    caHoc: parseInt(formData.get('CaHoc')),
                    phongThucHanhId: parseInt(formData.get('PhongThucHanhId'))
                };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                submitManualSchedule(result.value);
            }
        });
    }
    
    function xepLichThuCong(hpId, ma, ten) {
        showManualScheduleForm(null);
        // Pre-select the hocphan after a short delay
        setTimeout(() => {
            const select = document.querySelector('select[name="HocPhanId"]');
            if (select) {
                select.value = hpId;
            }
        }, 100);
    }
    
    function submitManualSchedule(data) {
        fetch('/SapXepLich/ThemLichThuCong', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công!',
                    text: result.message || 'Đã xếp lịch thành công',
                    timer: 2000
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: result.message || 'Không thể xếp lịch'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
                text: 'Có lỗi xảy ra khi xếp lịch'
            });
        });
    }
    
    // ===== AUTO SCHEDULE FORM =====
    function showAutoScheduleForm() {
        Swal.fire({
            title: '<i class="bi bi-robot me-2"></i>Sắp xếp lịch tự động',
            html: `
                <div class="text-start">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Hệ thống sẽ tự động sắp xếp lịch cho các học phần chưa xếp dựa trên:
                        <ul class="mb-0 mt-2">
                            <li>Phòng thực hành phù hợp với yêu cầu môn học</li>
                            <li>Lịch rảnh của giảng viên</li>
                            <li>Tránh trùng lịch phòng và giảng viên</li>
                            <li>Ưu tiên xếp vào các khung giờ hợp lý</li>
                        </ul>
                    </div>
                    <form id="autoScheduleForm">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-calendar-range me-1"></i>
                                Phạm vi ngày xếp lịch <span class="text-danger">*</span>
                            </label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="date" class="form-control" name="TuNgay" required>
                                    <small class="text-muted">Từ ngày</small>
                                </div>
                                <div class="col-6">
                                    <input type="date" class="form-control" name="DenNgay" required>
                                    <small class="text-muted">Đến ngày</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-clock me-1"></i>
                                Các ca ưu tiên
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1" name="CaHoc" checked>
                                <label class="form-check-label">Ca 1 (7:00-9:00)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="2" name="CaHoc" checked>
                                <label class="form-check-label">Ca 2 (9:15-11:15)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="3" name="CaHoc" checked>
                                <label class="form-check-label">Ca 3 (13:00-15:00)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="4" name="CaHoc" checked>
                                <label class="form-check-label">Ca 4 (15:15-17:15)</label>
                            </div>
                        </div>
                    </form>
                </div>
            `,
            width: '700px',
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-play-circle me-2"></i>Bắt đầu sắp xếp',
            cancelButtonText: '<i class="bi bi-x-circle me-2"></i>Hủy',
            confirmButtonColor: '#28a745',
            preConfirm: () => {
                const form = document.getElementById('autoScheduleForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return false;
                }
                
                const formData = new FormData(form);
                const selectedCa = Array.from(form.querySelectorAll('input[name="CaHoc"]:checked')).map(cb => parseInt(cb.value));
                
                if (selectedCa.length === 0) {
                    Swal.showValidationMessage('Vui lòng chọn ít nhất 1 ca học');
                    return false;
                }
                
                return {
                    tuNgay: formData.get('TuNgay'),
                    denNgay: formData.get('DenNgay'),
                    danhSachCa: selectedCa
                };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                submitAutoSchedule(result.value);
            }
        });
    }
    
    function submitAutoSchedule(data) {
        Swal.fire({
            title: 'Đang xử lý...',
            html: 'Hệ thống đang sắp xếp lịch tự động. Vui lòng chờ...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        fetch('/SapXepLich/TuDong', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công!',
                    html: `
                        <div class="text-start">
                            <p>${result.message}</p>
                            <ul>
                                <li><strong>Đã xếp:</strong> ${result.daXep || 0} học phần</li>
                                <li><strong>Không xếp được:</strong> ${result.khongXepDuoc || 0} học phần</li>
                            </ul>
                        </div>
                    `,
                    confirmButtonText: 'OK'
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: result.message || 'Không thể sắp xếp tự động'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
                text: 'Có lỗi xảy ra khi sắp xếp tự động'
            });
        });
    }
    
    // ===== EDIT/DELETE SCHEDULE =====
    function editSchedule(id) {
        Swal.fire('Thông báo', 'Chức năng sửa lịch đang được phát triển', 'info');
    }
    
    function deleteSchedule(id) {
        Swal.fire('Thông báo', 'Chức năng xóa lịch đang được phát triển', 'info');
    }
    
    // ===== GỬI DUYỆT =====
    function guiDuyet() {
        if (lichData.filter(l => l.trangThai === 0).length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Không có lịch để gửi',
                text: 'Không có lịch nào ở trạng thái chưa duyệt'
            });
            return;
        }
        
        Swal.fire({
            title: 'Xác nhận gửi duyệt',
            html: `
                <div class="text-start">
                    <p>Bạn có chắc chắn muốn gửi <strong>${lichData.filter(l => l.trangThai === 0).length} lịch</strong> để TTDT duyệt?</p>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Sau khi gửi, bạn sẽ không thể chỉnh sửa cho đến khi được duyệt hoặc từ chối.
                    </div>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-send me-2"></i>Gửi duyệt',
            cancelButtonText: 'Hủy',
            confirmButtonColor: '#0d6efd'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/SapXepLich/GuiDuyet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công!',
                            text: result.message || 'Đã gửi duyệt thành công',
                            timer: 2000
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi!',
                            text: result.message || 'Không thể gửi duyệt'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: 'Có lỗi xảy ra khi gửi duyệt'
                    });
                });
            }
        });
    }
    
    // ===== OTHER FUNCTIONS =====
    function refreshCalendar() {
        location.reload();
    }
    
    function exportExcel() {
        window.location.href = '/SapXepLich/ExportExcel';
    }
</script>
}
